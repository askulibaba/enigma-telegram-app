<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Авторизация...</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .error {
            color: #ff3b30;
            margin-top: 16px;
            text-align: center;
            padding: 12px;
            background-color: rgba(255, 59, 48, 0.1);
            border-radius: 8px;
            max-width: 80%;
        }
        .loading {
            text-align: center;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Авторизация...</div>
    <div id="error" class="error" style="display: none;"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        try {
            // Получаем параметры авторизации из URL
            const urlParams = new URLSearchParams(window.location.search);
            const authData = {
                id: urlParams.get('id'),
                first_name: urlParams.get('first_name'),
                last_name: urlParams.get('last_name'),
                username: urlParams.get('username'),
                photo_url: urlParams.get('photo_url'),
                auth_date: urlParams.get('auth_date'),
                hash: urlParams.get('hash')
            };

            // Проверяем наличие необходимых данных
            if (!authData.id || !authData.hash) {
                showError('Ошибка авторизации: отсутствуют необходимые данные');
                console.error('Auth data:', authData);
                return;
            }

            // Сохраняем данные авторизации
            localStorage.setItem('telegram_auth', JSON.stringify(authData));
            console.log('Auth data saved:', authData);

            // Отправляем данные в бот
            tg.sendData(JSON.stringify({
                type: 'auth',
                data: authData
            }));
            console.log('Data sent to bot');

            // Ждем ответа от бота с диалогами
            let timeoutId = setTimeout(() => {
                showError('Превышено время ожидания ответа от бота');
            }, 30000); // 30 секунд таймаут

            tg.onEvent('message', function(event) {
                clearTimeout(timeoutId);
                try {
                    console.log('Received message from bot:', event);
                    const data = JSON.parse(event.data);
                    if (Array.isArray(data)) {
                        localStorage.setItem('telegram_dialogs', JSON.stringify(data));
                        window.location.href = 'chats.html';
                    } else {
                        showError('Неверный формат данных от бота');
                        console.error('Invalid data format:', data);
                    }
                } catch (e) {
                    showError('Ошибка при обработке ответа от бота: ' + e.message);
                    console.error('Error parsing bot response:', e);
                }
            });

        } catch (e) {
            showError('Произошла ошибка: ' + e.message);
            console.error('General error:', e);
        }
    </script>
</body>
</html> 